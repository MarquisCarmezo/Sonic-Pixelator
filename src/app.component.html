<!-- Main "Rack Unit" Container -->
<div class="w-full max-w-5xl bg-[#1c1917] rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.8)] border-4 border-[#292524] relative overflow-hidden ring-1 ring-white/10">
  
  <!-- Screw Heads (Decor) - Brass/Gold look -->
  <div class="absolute top-4 left-4 w-4 h-4 rounded-full bg-[#78350f] shadow-inner flex items-center justify-center border border-[#92400e]"><div class="w-2 h-0.5 bg-[#451a03] rotate-45"></div></div>
  <div class="absolute top-4 right-4 w-4 h-4 rounded-full bg-[#78350f] shadow-inner flex items-center justify-center border border-[#92400e]"><div class="w-2 h-0.5 bg-[#451a03] rotate-45"></div></div>
  <div class="absolute bottom-4 left-4 w-4 h-4 rounded-full bg-[#78350f] shadow-inner flex items-center justify-center border border-[#92400e]"><div class="w-2 h-0.5 bg-[#451a03] rotate-45"></div></div>
  <div class="absolute bottom-4 right-4 w-4 h-4 rounded-full bg-[#78350f] shadow-inner flex items-center justify-center border border-[#92400e]"><div class="w-2 h-0.5 bg-[#451a03] rotate-45"></div></div>

  <!-- Faceplate Texture - Brushed Metal Dark -->
  <div class="bg-[#292524] p-8 pb-12 relative border-b-8 border-[#1c1917]">
    
    <!-- Top Display Panel -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-2 border-[#44403c] pb-6 bg-[#0c0a09]/30 p-4 rounded-xl">
      <div class="flex items-center space-x-6">
        <!-- Power Light -->
        <div class="relative flex flex-col items-center">
          <div class="w-4 h-4 rounded-full bg-red-600 shadow-[0_0_12px_#dc2626] animate-pulse border border-red-900"></div>
          <span class="text-[9px] text-stone-500 font-mono-tech mt-1 tracking-widest">PWR</span>
        </div>
        
        <!-- Logo Area -->
        <div class="border-l-2 border-[#44403c] pl-6">
            <h1 class="font-tech text-4xl text-stone-200 tracking-widest uppercase drop-shadow-[2px_2px_0_rgba(0,0,0,0.5)]">
            Sonic <span class="text-orange-500 font-bold">Pixelator</span>
            </h1>
            <div class="text-[10px] text-orange-700 font-mono-tech tracking-[0.3em] mt-1">PUT YOUR SONGS INTO YOUR PHOTOS</div>
        </div>
      </div>

      <!-- Help Button -->
      <button (click)="toggleInfo()" class="mt-4 md:mt-0 px-4 py-2 bg-[#44403c] hover:bg-[#57534e] text-orange-200 font-mono-tech text-xs rounded border border-[#57534e] shadow-lg active:translate-y-0.5 transition-all">
         [ ? ] HELP MANUAL
      </button>
    </div>

    <!-- Main Interface Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- LEFT COLUMN: CONTROLS (Tape Deck Style) -->
      <!-- Increased min-h to 600px to accommodate 'Stego' mode content without shifting -->
      <div class="lg:col-span-7 space-y-8 min-h-[600px]">
        
        <!-- Operation Mode Switch (Chunky Buttons) -->
        <div class="bg-[#1c1917] p-5 rounded-md shadow-[inset_0_2px_4px_rgba(0,0,0,0.6)] border border-[#44403c]">
          <label class="block font-mono-tech text-xs text-orange-400 mb-3 uppercase tracking-widest flex items-center">
             <div class="w-2 h-2 bg-orange-500 rounded-full mr-2"></div> SELECT MODE
          </label>
          <div class="flex space-x-4">
            <button 
              (click)="setMode('encode')"
              class="flex-1 btn-retro py-4 font-tech font-bold tracking-wider text-sm rounded bg-[#d6d3d1] text-stone-900 border-t border-white"
              [class.bg-orange-500]="mode() === 'encode'"
              [class.text-white]="mode() === 'encode'"
              [class.border-orange-300]="mode() === 'encode'">
              ENCODE
            </button>
            <button 
              (click)="setMode('decode')"
              class="flex-1 btn-retro py-4 font-tech font-bold tracking-wider text-sm rounded bg-[#d6d3d1] text-stone-900 border-t border-white"
              [class.bg-teal-600]="mode() === 'decode'"
              [class.text-white]="mode() === 'decode'"
              [class.border-teal-400]="mode() === 'decode'">
              DECODE
            </button>
          </div>
        </div>

        <!-- Error Readout -->
        @if (error()) {
          <div class="bg-red-950/40 border border-red-800/50 p-4 rounded font-mono-tech text-red-400 text-sm flex items-center shadow-[0_0_15px_rgba(220,38,38,0.1)]">
            <span class="animate-blink mr-2 text-red-500">⚠</span> {{ error() }}
          </div>
        }

        <!-- ENCODE CONTROLS -->
        @if (mode() === 'encode') {
          <div class="space-y-6 animate-in fade-in slide-in-from-left-4">
            
            <!-- Type Toggle -->
            <div class="flex items-center justify-between bg-[#1c1917] p-2 rounded border border-[#44403c]">
              <button 
                (click)="setEncodeType('stego')"
                class="flex-1 py-2 text-xs font-mono-tech uppercase transition-colors rounded hover:bg-[#292524]"
                [class.text-orange-400]="encodeType() === 'stego'"
                [class.bg-[#292524]]="encodeType() === 'stego'"
                [class.text-stone-600]="encodeType() !== 'stego'">
                Hide In Photo
              </button>
              <div class="w-px h-6 bg-[#44403c] mx-2"></div>
              <button 
                (click)="setEncodeType('noise')"
                class="flex-1 py-2 text-xs font-mono-tech uppercase transition-colors rounded hover:bg-[#292524]"
                [class.text-orange-400]="encodeType() === 'noise'"
                [class.bg-[#292524]]="encodeType() === 'noise'"
                [class.text-stone-600]="encodeType() !== 'noise'">
                Visualize Audio
              </button>
            </div>

            <!-- Input Slots -->
            <div class="space-y-4">
              <!-- Audio Slot -->
              <div class="relative group">
                <label class="block font-mono-tech text-xs text-stone-500 mb-1 uppercase">Input A: Audio Source</label>
                <div class="h-16 bg-[#1c1917] rounded border-2 border-dashed border-[#44403c] group-hover:border-orange-500 transition-colors flex items-center px-4 relative overflow-hidden">
                   <input type="file" accept="audio/*" (change)="onAudioSelected($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                   @if (selectedAudioFile()) {
                     <div class="w-full flex justify-between items-center text-orange-200 font-mono-tech text-sm">
                        <span class="truncate flex items-center"><span class="text-orange-600 mr-2">♪</span> {{ selectedAudioFile()?.name }}</span>
                        <span class="text-[10px] bg-orange-950/50 text-orange-500 border border-orange-900 px-2 py-1 rounded ml-2">RAW</span>
                     </div>
                   } @else {
                     <span class="text-stone-600 font-mono-tech text-sm group-hover:text-stone-400 transition-colors">INSERT AUDIO TAPE...</span>
                   }
                </div>
              </div>

              <!-- Image Slot -->
              @if (encodeType() === 'stego') {
                <div class="relative group animate-in fade-in">
                  <label class="block font-mono-tech text-xs text-stone-500 mb-1 uppercase">Input B: Cover Image</label>
                  <div class="h-16 bg-[#1c1917] rounded border-2 border-dashed border-[#44403c] group-hover:border-orange-500 transition-colors flex items-center px-4 relative overflow-hidden">
                     <input type="file" accept="image/*" (change)="onCoverImageSelected($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                     @if (selectedCoverImage()) {
                       <div class="w-full flex justify-between items-center text-orange-200 font-mono-tech text-sm">
                          <span class="truncate flex items-center"><span class="text-orange-600 mr-2">IMG</span> {{ selectedCoverImage()?.name }}</span>
                          <span class="text-[10px] bg-orange-950/50 text-orange-500 border border-orange-900 px-2 py-1 rounded ml-2">PNG/JPG</span>
                       </div>
                     } @else {
                       <span class="text-stone-600 font-mono-tech text-sm group-hover:text-stone-400 transition-colors">INSERT COVER PHOTO...</span>
                     }
                  </div>
                </div>

                <!-- Density Knobs UI -->
                <div class="bg-[#1c1917] p-4 rounded border border-[#44403c]">
                   <div class="flex justify-between items-end mb-2">
                      <label class="font-mono-tech text-xs text-stone-500">DATA DENSITY</label>
                      <span class="font-tech text-orange-400 text-lg">{{ density() }} <span class="text-xs text-stone-600">BPC</span></span>
                   </div>
                   <!-- Styled Range Input -->
                   <div class="relative h-2 bg-[#292524] rounded-lg">
                       <input 
                        type="range" 
                        min="1" 
                        max="7" 
                        step="1" 
                        [value]="density()" 
                        (input)="onDensityChange($event)"
                        class="absolute w-full h-full opacity-0 cursor-pointer z-10"
                       />
                       <div class="absolute h-full bg-orange-600 rounded-lg pointer-events-none" [style.width.%]="(density() - 1) / 6 * 100"></div>
                       <div class="absolute h-4 w-4 bg-stone-300 rounded-full shadow border border-stone-400 top-1/2 -translate-y-1/2 -ml-2 pointer-events-none" [style.left.%]="(density() - 1) / 6 * 100"></div>
                   </div>

                   <div class="flex justify-between text-[10px] font-mono-tech text-stone-600 mt-3 uppercase">
                      <span>High Res</span>
                      <span class="text-orange-700/50">Balanced</span>
                      <span>Noisy</span>
                   </div>
                </div>
              }
            </div>

            <!-- Master Action Button -->
            <button 
              (click)="generateImage()"
              [disabled]="isProcessing() || !selectedAudioFile() || (encodeType() === 'stego' && !selectedCoverImage())"
              class="w-full btn-retro h-20 bg-gradient-to-b from-orange-600 to-orange-700 hover:from-orange-500 hover:to-orange-600 disabled:from-[#44403c] disabled:to-[#292524] text-white font-tech font-bold text-xl rounded shadow-lg border-t border-orange-400 disabled:border-stone-600 tracking-widest flex items-center justify-center">
              @if (isProcessing()) {
                <span class="animate-pulse flex items-center"><div class="w-3 h-3 bg-white rounded-full mr-2 animate-bounce"></div> PROCESSING...</span>
              } @else {
                INITIALIZE ENCODE
              }
            </button>

          </div>
        }

        <!-- DECODE CONTROLS -->
        @if (mode() === 'decode') {
           <div class="space-y-6 animate-in fade-in slide-in-from-right-4">
              <div class="bg-[#1c1917]/50 p-6 rounded text-center border border-[#44403c]">
                <p class="font-mono-tech text-sm text-teal-600 mb-4 tracking-widest">DECODER MODULE ACTIVE</p>
                
                <div class="relative group max-w-sm mx-auto">
                    <div class="h-32 bg-[#1c1917] rounded border-2 border-dashed border-[#44403c] group-hover:border-teal-500 transition-colors flex flex-col items-center justify-center relative overflow-hidden shadow-inner">
                       <input type="file" accept="image/png" (change)="onImageSelected($event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                       <svg class="w-10 h-10 text-stone-700 mb-2 group-hover:text-teal-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                       @if (selectedImageFile()) {
                           <span class="text-teal-400 font-mono-tech text-xs">{{ selectedImageFile()?.name }}</span>
                       } @else {
                           <span class="text-stone-600 font-mono-tech text-xs">INSERT SONIC IMAGE</span>
                       }
                    </div>
                </div>
              </div>

              @if (selectedImageFile() && !decodedResult()) {
                  <button 
                  (click)="decodeImage()"
                  [disabled]="isProcessing()"
                  class="w-full btn-retro h-20 bg-gradient-to-b from-teal-700 to-teal-800 hover:from-teal-600 hover:to-teal-700 disabled:from-[#44403c] disabled:to-[#292524] text-white font-tech font-bold text-xl rounded shadow-lg border-t border-teal-500 disabled:border-stone-600 tracking-widest flex items-center justify-center">
                  @if (isProcessing()) {
                    <span class="animate-pulse">DECODING...</span>
                  } @else {
                    EXTRACT DATA
                  }
                </button>
              }
           </div>
        }

      </div>

      <!-- RIGHT COLUMN: VISUALIZER (Spinning Disc) -->
      <!-- Matched height to left column (600px) -->
      <div class="lg:col-span-5 flex flex-col items-center justify-center bg-[#151413] rounded-xl border-4 border-[#1c1917] p-6 relative shadow-inner h-[600px]">
        <!-- Shine reflection -->
        <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-white/5 to-transparent pointer-events-none z-20 rounded-lg"></div>

        <!-- The Vinyl Record Container -->
        <!-- Binding style.transform directly for JS-based physics -->
        <div class="relative w-64 h-64 md:w-72 md:h-72 mb-8 transition-transform duration-700"
             #vinylContainer
             [class.scale-95]="!isProcessing() && !generatedImageUrl() && !decodedAudioUrl()">
             
            <!-- Record SVG with visible graphics for rotation -->
            <svg 
              (mousedown)="startScratch($event)"
              [style.transform]="'rotate(' + rotationAngle() + 'deg)'"
              viewBox="0 0 100 100" 
              class="w-full h-full drop-shadow-2xl cursor-grab active:cursor-grabbing will-change-transform">
              
              <!-- Outer Ring (Vinyl) -->
              <circle cx="50" cy="50" r="49" fill="#111" />
              <!-- Shine on vinyl -->
              <circle cx="50" cy="50" r="48" fill="none" stroke="#222" stroke-width="1.5" />
              
              <!-- Grooves -->
              <circle cx="50" cy="50" r="45" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="42" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="39" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="36" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="33" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="30" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="27" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              <circle cx="50" cy="50" r="24" fill="none" stroke="#1a1a1a" stroke-width="0.3" />
              
              <!-- Label Background -->
              <circle cx="50" cy="50" r="19" [attr.fill]="mode() === 'encode' ? '#ea580c' : '#0d9488'" />
              
              <!-- Label Details for VISIBLE ROTATION -->
              <g [attr.fill]="mode() === 'encode' ? '#9a3412' : '#0f766e'"> 
                  <!-- Center Stripe -->
                  <rect x="31" y="48" width="38" height="4" />
                  <!-- Top Curve -->
                  <path d="M 36,44 A 12,12 0 0,1 64,44" fill="none" stroke="currentColor" stroke-width="1" />
              </g>

              <!-- Spindle Hole -->
              <circle cx="50" cy="50" r="3" fill="#000" stroke="#333" stroke-width="0.5" /> 

              <!-- Curved Text Path -->
              <path id="curveTop" d="M 30,50 A 20,20 0 0,1 70,50" fill="none" />
              <path id="curveBottom" d="M 32,50 A 18,18 0 0,0 68,50" fill="none" />
              
              <text font-size="3.5" font-family="monospace" font-weight="bold" fill="white" letter-spacing="0.5">
                 <textPath href="#curveTop" startOffset="50%" text-anchor="middle">SONIC PIXELATOR</textPath>
              </text>
              <text font-size="2.5" font-family="monospace" fill="rgba(255,255,255,0.7)" letter-spacing="1">
                 <textPath href="#curveBottom" startOffset="50%" text-anchor="middle">HI-FI AUDIO SYSTEM</textPath>
              </text>
            </svg>

            <!-- Tonearm -->
            <div 
                 (click)="toggleTonearm()"
                 class="absolute top-0 -right-4 w-12 h-44 origin-top cursor-pointer z-30 transition-transform duration-500 ease-in-out" 
                 style="transform-origin: 24px 24px;"
                 [class.rotate-[35deg]]="isProcessing()"
                 [class.rotate-[22deg]]="!isProcessing() && isTonearmOnRecord()"
                 [class.rotate-0]="!isProcessing() && !isTonearmOnRecord()">
                 
                 <!-- Pivot Base -->
                 <div class="absolute top-2 left-3 w-10 h-10 rounded-full bg-[#57534e] shadow-lg border-2 border-[#292524] flex items-center justify-center">
                    <div class="w-4 h-4 bg-[#1c1917] rounded-full"></div>
                 </div>
                 
                 <!-- Arm - Curved Stainless Steel look -->
                 <div class="absolute top-8 left-7 w-1.5 h-32 bg-[#a8a29e] shadow-[2px_2px_4px_rgba(0,0,0,0.5)] border-l border-white/40 z-10"></div>
                 
                 <!-- Head shell -->
                 <div class="absolute bottom-2 left-5 w-7 h-11 bg-[#44403c] rounded-sm shadow-md border border-[#57534e] rotate-12 z-20 flex flex-col items-center justify-end pb-1">
                    <div class="w-4 h-0.5 bg-white/50 mb-1"></div>
                 </div>
            </div>
        </div>

        <!-- Result Display Area (CRT Screen Look) -->
        <div class="w-full crt-screen rounded border-4 border-[#292524] p-4 min-h-[160px] flex flex-col items-center justify-center text-center relative bg-[#0f0f0f]">
            
            @if (generatedImageUrl()) {
              <p class="font-mono-tech text-xs text-orange-400 mb-2 typewriter tracking-widest">>> ENCODING_SUCCESSFUL</p>
              <p class="font-mono-tech text-[10px] text-stone-500 mb-4 uppercase">{{ imageDimensions() }} // {{ encodeType() }}</p>
              
              <button 
                (click)="downloadImage()"
                class="bg-orange-700 hover:bg-orange-600 text-white font-mono-tech text-xs px-6 py-2 rounded-sm shadow border border-orange-500 uppercase tracking-widest">
                Download Master PNG
              </button>
            } 
            
            @if (decodedResult()) {
              <!-- Now Playing Card -->
              <div class="w-full h-full absolute inset-0 flex flex-col overflow-hidden">
                  <!-- Blurred Background -->
                  <div class="absolute inset-0 bg-cover bg-center blur-sm brightness-[0.25] z-0" [style.background-image]="'url(' + decodedCoverUrl() + ')'"></div>
                  
                  <!-- Card Content -->
                  <div class="relative z-10 flex flex-col items-center justify-center h-full p-4 space-y-3">
                      <div class="font-mono-tech text-[10px] text-teal-400 self-start w-full text-left border-b border-teal-800 pb-1 mb-1 flex justify-between tracking-widest">
                         <span>>> AUDIO EXTRACTED</span>
                         <span [class.animate-pulse]="isPlaying()" [class.text-stone-600]="!isPlaying()">
                           {{ isPlaying() ? 'PLAYING' : 'PAUSED' }}
                         </span>
                      </div>

                      <!-- Album Art -->
                      <div class="relative w-24 h-24 rounded-sm overflow-hidden shadow-2xl border border-stone-600 bg-black">
                           <img [src]="decodedCoverUrl()" class="w-full h-full object-contain" alt="Album Cover">
                      </div>
                      
                      <!-- Track Info -->
                      <p class="font-mono-tech text-xs text-stone-200 truncate max-w-[90%] uppercase tracking-wide">{{ decodedResult()?.fileName }}</p>
                      
                      <!-- Hidden Audio Player (Controlled by Vinyl/Arm) -->
                      <audio 
                        #audioPlayer 
                        class="w-full h-8 opacity-80 contrast-125 grayscale" 
                        controls
                        (play)="onAudioPlay()"
                        (pause)="onAudioPause()"
                        (ended)="onAudioEnded()"
                        [src]="decodedAudioUrl()">
                      </audio>
                  </div>
              </div>
            }

            @if (!generatedImageUrl() && !decodedResult() && !isProcessing()) {
              <p class="font-mono-tech text-xs text-stone-600 animate-pulse tracking-widest">AWAITING MEDIA INPUT...</p>
            }
            
            @if (isProcessing()) {
              <p class="font-mono-tech text-xs text-orange-400 animate-pulse tracking-widest">PROCESSING DATA STREAM...</p>
            }
        </div>

      </div>

    </div>
  </div>

  <!-- Footer/Ventilation Removed -->

  <!-- Modal Overlay -->
  @if (showInfo()) {
     <div class="fixed inset-0 z-50 flex items-center justify-center backdrop-retro p-4 animate-in fade-in">
        <div class="bg-[#1c1917] border-2 border-orange-800 rounded-lg shadow-2xl max-w-lg w-full p-6 relative">
           <button (click)="toggleInfo()" class="absolute top-2 right-2 text-stone-500 hover:text-white font-mono-tech">[X] CLOSE</button>
           
           <h2 class="font-tech text-2xl text-orange-500 mb-4 border-b border-stone-700 pb-2">OPERATION MANUAL</h2>
           
           <div class="space-y-4 font-mono-tech text-stone-300 text-sm h-64 overflow-y-auto pr-2">
              <p><strong>MISSION:</strong> Store confidential audio recordings inside innocent-looking photographs.</p>
              
              <div class="bg-[#0c0a09] p-3 rounded border border-stone-800">
                  <h3 class="text-orange-400 mb-1">MODE: ENCODE</h3>
                  <p class="text-xs text-stone-500">1. Upload Audio Tape (MP3/WAV)</p>
                  <p class="text-xs text-stone-500">2. Select Cover Photo (JPG/PNG)</p>
                  <p class="text-xs text-stone-500">3. Adjust Data Density. Higher = More Noise.</p>
                  <p class="text-xs text-stone-500">4. Download the generated PNG.</p>
              </div>

              <div class="bg-[#0c0a09] p-3 rounded border border-stone-800">
                  <h3 class="text-teal-400 mb-1">MODE: DECODE</h3>
                  <p class="text-xs text-stone-500">1. Upload a Sonic Pixelator PNG.</p>
                  <p class="text-xs text-stone-500">2. System extracts audio automatically.</p>
                  <p class="text-xs text-stone-500">3. Drop the Tonearm to play.</p>
              </div>

              <p class="text-xs italic text-stone-500 mt-4">WARNING: Sharing images on social media often compresses them (JPG), destroying the data. Share files as documents/PNGs only.</p>
           </div>
           
           <button (click)="toggleInfo()" class="w-full mt-6 bg-orange-800 hover:bg-orange-700 text-white font-mono-tech py-2 rounded uppercase text-sm">Acknowledge</button>
        </div>
     </div>
  }
</div>